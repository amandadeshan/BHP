<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #userList {
            display: flex;
            flex-wrap: wrap;
        }
        .user-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        .completed {
            background-color: #d4edda;
        }
        #userTable {
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .time-input {
            width: 100px;
        }
        #addRemoveModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #addRemoveModal ul {
            list-style: none;
            padding: 0;
        }
        #addRemoveModal li {
            padding: 5px 0;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAsTV4AJ7PlQgz4emu4ASChNxetbxKwjO4",
  authDomain: "bhputtlam.firebaseapp.com",
  projectId: "bhputtlam",
  storageBucket: "bhputtlam.appspot.com",
  messagingSenderId: "486977736733",
  appId: "1:486977736733:web:72008f27c6b5cdceb776f4",
  measurementId: "G-60VET4K9Y2"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body>
    <h1>OT Calculation</h1>
    <label for="month">Month:</label>
    <input type="month" id="month" onchange="showUsers()">
    
    <label for="department">Department:</label>
    <select id="department" onchange="showUsers()">
        <option value="BHP">BHP</option>
        <option value="MLT">MLT</option>
    </select>
    
    <button onclick="openAddRemoveModal()">Add/Remove Users</button>
    
    <div id="userList"></div>
    
    <div id="userTable">
        <h2 id="tableHeader"></h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>In Time</th>
                    <th>Out Time</th>
                    <th>OT Hours</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <button onclick="goBack()">Back</button>
        <button onclick="completeUser()">Complete</button>
    </div>
    
    <!-- Modal for Add/Remove Users -->
    <div id="addRemoveModal">
        <h2>Add/Remove Users</h2>
        <ul id="addRemoveUserList"></ul>
        <button onclick="closeAddRemoveModal()">Close</button>
    </div>

    <script>
        let currentUserBox = null;
        let currentUserData = {}; // To store current user data

        const users = {
            BHP: ['K.P.I. Malkanthi', 'W.D.R.C.Wijesiri','A.M.R.T.Atapaththu','N.M.R.Abeynayaka','J.M.C.N.Jayasunara','K.M.Nihal','M.R.Ansifa','W.M.S.R.Rajapaksha','M.J.J.Mohomed','A.C.Naushad' ,'V.L.S.De Mel','H.M.I.D.Herath','H.P.U.Manjula','M.F.M.Fasarath','L.I.Chandrasekara','J.D.Jegadhalini','H.P.D.P.N.Gunathilaka','S.M.Sacky','R.R.Shareef','D.M.M.Diwakara','H.M.P.Herath','A.M.Arshath'],
            MLT: Array.from({ length: 30 }, (_, i) => `User${i + 1}`)
        };

        function loadCompletedUsers() {
            const month = document.getElementById('month').value;
            return db.collection('completedUsers').doc(month).get()
                .then(doc => doc.exists ? doc.data() : {})
                .catch(error => {
                    console.error('Error fetching completed users:', error);
                    return {};
                });
        }

        function saveCompletedUser(user) {
            const month = document.getElementById('month').value;
            const department = document.getElementById('department').value;
            db.collection('completedUsers').doc(month).set({
                [department]: firebase.firestore.FieldValue.arrayUnion(user)
            }, { merge: true })
            .then(() => console.log('Completed users successfully saved!'))
            .catch(error => console.error('Error saving completed users:', error));
            saveUserData(user); // Save data when user is marked as completed
        }

        function saveUserData(user) {
            const month = document.getElementById('month').value;
            const department = document.getElementById('department').value;
            db.collection('userData').doc(month).set({
                [department]: {
                    [user]: currentUserData
                }
            }, { merge: true })
            .then(() => console.log('User data successfully saved!'))
            .catch(error => console.error('Error saving user data:', error));
        }

        function showUsers() {
            const department = document.getElementById('department').value;
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            loadCompletedUsers().then(completedUsers => {
                const completedUserList = completedUsers[department] || [];
                users[department].forEach(user => {
                    const userBox = document.createElement('div');
                    userBox.classList.add('user-box');
                    userBox.innerText = user;
                    userBox.dataset.user = user;
                    userBox.onclick = () => showTable(userBox);

                    if (completedUserList.includes(user)) {
                        userBox.classList.add('completed');
                    }

                    userList.appendChild(userBox);
                });
            });
        }

        function showTable(userBox) {
            currentUserBox = userBox;
            currentUserData = {}; // Reset current user data
            const user = userBox.dataset.user;
            const tableBody = document.getElementById('tableBody');
            const month = document.getElementById('month').value;
            const year = new Date().getFullYear();
            const daysInMonth = new Date(year, month, 0).getDate();

            tableBody.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.toLocaleString('en-US', { weekday: 'long' });
                const formattedDate = date.toISOString().split('T')[0];

                const row = document.createElement('tr');
                row.innerHTML = 
                    `<td>${formattedDate}</td>
                    <td>${dayOfWeek}</td>
                    <td><input type="text" class="time-input in-time" placeholder="e.g., 08:00 AM" /></td>
                    <td><input type="text" class="time-input out-time" placeholder="e.g., 05:00 PM" /></td>
                    <td class="ot-hours">0</td>`;
                tableBody.appendChild(row);
            }

            document.getElementById('tableHeader').innerText = `OT Calculation for ${user}`;
            document.getElementById('userTable').style.display = 'block';

            initializeTimeInputs();
        }

        function initializeTimeInputs() {
            const inTimeInputs = document.querySelectorAll('.in-time');
            const outTimeInputs = document.querySelectorAll('.out-time');

            inTimeInputs.forEach(input => setupTimeInput(input, true));
            outTimeInputs.forEach(input => setupTimeInput(input, false));
        }

        function setupTimeInput(input, isIn) {
            input.addEventListener('input', function() {
                let value = this.value;
                let [hours, minutes] = value.split(':');
                let ampm = '';

                if (hours) {
                    hours = hours.trim();
                    if (hours.length === 1) hours = '0' + hours;
                }

                if (hours >= 12) {
                    ampm = 'PM';
                    if (hours > 12) hours -= 12;
                } else {
                    ampm = 'AM';
                }

                if (hours == 0) hours = 12;

                this.value = `${hours}:${minutes || '00'} ${ampm}`;

                if (isIn) calculateOTHours();
                else calculateOTHours();
            });
        }

        function calculateOTHours() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const inTime = row.querySelector('.in-time').value;
                const outTime = row.querySelector('.out-time').value;

                if (inTime && outTime) {
                    const inTimeDate = new Date(`1970-01-01T${convertTo24Hour(inTime)}:00`);
                    const outTimeDate = new Date(`1970-01-01T${convertTo24Hour(outTime)}:00`);
                    const otHours = (outTimeDate - inTimeDate) / (1000 * 60 * 60);
                    row.querySelector('.ot-hours').innerText = otHours.toFixed(2);
                } else {
                    row.querySelector('.ot-hours').innerText = '0';
                }
            });
        }

        function convertTo24Hour(timeStr) {
            const [time, modifier] = timeStr.split(' ');
            let [hours, minutes] = time.split(':');

            if (modifier === 'PM' && hours !== '12') hours = parseInt(hours) + 12;
            if (modifier === 'AM' && hours === '12') hours = '00';

            return `${hours}:${minutes}`;
        }

        function goBack() {
            document.getElementById('userTable').style.display = 'none';
        }

        function completeUser() {
            if (currentUserBox) {
                const user = currentUserBox.dataset.user;
                saveCompletedUser(user);
                currentUserBox.classList.add('completed');
                goBack();
            }
        }

        function openAddRemoveModal() {
            const department = document.getElementById('department').value;
            const userList = document.getElementById('addRemoveUserList');
            userList.innerHTML = '';

            users[department].forEach(user => {
                const item = document.createElement('li');
                item.textContent = user;
                userList.appendChild(item);
            });

            document.getElementById('addRemoveModal').style.display = 'block';
        }

        function closeAddRemoveModal() {
            document.getElementById('addRemoveModal').style.display = 'none';
        }
    </script>
</body>
</html>
